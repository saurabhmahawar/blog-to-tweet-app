<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog to Thread Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tweet-card {
            min-height: 100px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .tweet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Style for the slider track fill */
        input[type="range"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 9999px;
            background: #e5e7eb;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #204e57 var(--slider-progress), #e5e7eb var(--slider-progress));
            border-radius: 9999px;
            height: 8px;
        }
        input[type="range"]::-moz-range-track {
            background: linear-gradient(to right, #204e57 var(--slider-progress), #e5e7eb var(--slider-progress));
            border-radius: 9999px;
            height: 8px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #204e57;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.2s ease-in-out;
            margin-top: -6px; /* Aligns the thumb with the track */
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #204e57;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.2s ease-in-out;
        }
        /* Toggle button styles */
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-label {
            display: block;
            width: 40px;
            height: 20px;
            background: #cbd5e1;
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .toggle-label:after {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 2px;
            width: 16px;
            height: 16px;
            background: #ffffff;
            border-radius: 50%;
            transition: transform 0.2s ease-in-out;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #204e57;
        }
        .toggle-checkbox:checked + .toggle-label:after {
            transform: translateY(-50%) translateX(20px);
        }
        /* Notification styles */
        #message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a202c;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #message-box.visible {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-12 px-4">

    <div class="bg-white p-8 md:p-10 rounded-3xl shadow-xl max-w-4xl w-full">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Blog ‚Üí Thread Converter ‚ù§Ô∏è</h1>
            <p class="text-gray-500 mt-2">Transform your blog posts into engaging Twitter threads ùïè üßµ</p>
        </div>

        <div id="input-section" class="space-y-6">
            <div>
                <label for="url-input" class="block text-sm font-semibold text-gray-700">Blog URL (Optional)</label>
                <input type="url" id="url-input" placeholder="Enter blog URL (Medium, LinkedIn, etc.)" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <p class="mt-1 text-xs text-gray-500">
                    Leave empty if pasting text below
                </p>
            </div>

            <div class="relative flex items-center py-2">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <div>
                <label for="text-input" class="block text-sm font-semibold text-gray-700">Blog Content</label>
                <textarea id="text-input" rows="10" placeholder="Paste your blog content here (up to 5000 words)" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 resize-y focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                <p id="word-count" class="mt-1 text-xs text-gray-500 text-right">0 / 5000 words</p>
            </div>

            <div class="mt-4">
                <label for="tweet-count" class="block text-sm font-semibold text-gray-700 mb-2">Number of tweets in thread: <span id="tweet-count-display" class="font-bold text-gray-800">5</span></label>
                <input type="range" id="tweet-count" value="5" min="3" max="15" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <p class="mt-1 text-xs text-gray-500">Choose between 3-15 tweets</p>
            </div>

            <div class="mt-4 flex items-center justify-between">
                <label for="image-toggle" class="text-sm font-semibold text-gray-700 cursor-pointer">Need an Image for the tweet?</label>
                <div class="relative inline-flex items-center">
                    <input type="checkbox" name="image-toggle" id="image-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition duration-200">
                    <label for="image-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
            </div>

            <button id="convert-btn" class="w-full py-3 px-4 bg-teal-700 hover:bg-teal-800 text-white font-semibold rounded-xl shadow-lg transition duration-200 ease-in-out">
                Convert to Thread
            </button>
        </div>

        <div id="output-section" class="hidden mt-10">
            <div id="loading" class="hidden text-center text-gray-500 font-semibold my-8">
                <div class="flex flex-col items-center justify-center">
                    <svg class="animate-spin h-8 w-8 text-teal-700 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Generating your thread...</span>
                    <span id="image-loading-text" class="hidden mt-2 text-sm text-gray-500">Generating image...</span>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Twitter Thread</h2>
            
            <div id="image-container" class="my-4 hidden">
                <p class="text-sm font-semibold text-gray-700 mb-2">Generated Image for Tweet 1:</p>
                <img id="generated-image" class="w-full rounded-xl shadow-lg" alt="Generated image based on tweet content">
                <a id="download-image-btn" download="generated-image.png" class="mt-4 inline-block py-2 px-6 bg-teal-700 hover:bg-teal-800 text-white font-semibold rounded-xl shadow-lg transition duration-200 ease-in-out">Download Image</a>
            </div>

            <div id="tweet-container" class="space-y-4">
                </div>
            
            <div class="mt-6 flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                <button id="copy-all-btn" class="py-3 px-6 bg-teal-700 hover:bg-teal-800 text-white font-semibold rounded-xl shadow-lg transition duration-200 ease-in-out">
                    Copy All Tweets
                </button>
            </div>
        </div>
        
        <div id="message-box" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-900 text-white p-4 rounded-full shadow-lg transition-opacity duration-300 z-50 invisible opacity-0">
            <p id="message-text" class="text-sm font-medium"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlInput = document.getElementById('url-input');
            const textInput = document.getElementById('text-input');
            const tweetCountInput = document.getElementById('tweet-count');
            const tweetCountDisplay = document.getElementById('tweet-count-display');
            const wordCountDisplay = document.getElementById('word-count');
            const imageToggle = document.getElementById('image-toggle');
            const convertBtn = document.getElementById('convert-btn');
            const outputSection = document.getElementById('output-section');
            const loadingIndicator = document.getElementById('loading');
            const imageLoadingText = document.getElementById('image-loading-text');
            const tweetContainer = document.getElementById('tweet-container');
            const copyAllBtn = document.getElementById('copy-all-btn');
            const imageContainer = document.getElementById('image-container');
            const generatedImage = document.getElementById('generated-image');
            const downloadImageBtn = document.getElementById('download-image-btn');
            
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            let shouldGenerateImage = false;
            let blogContent = '';

            // Function to show a temporary message
            function showMessage(text, duration = 3000) {
                messageText.textContent = text;
                messageBox.classList.remove('invisible', 'opacity-0');
                messageBox.classList.add('visible', 'opacity-100');
                setTimeout(() => {
                    messageBox.classList.remove('visible', 'opacity-100');
                    messageBox.classList.add('invisible', 'opacity-0');
                }, duration);
            }

            // Function to generate content via the Serverless Function
            async function generateContent(payload) {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `API request failed with status: ${response.status}`);
                }

                return await response.json();
            }

            // Update slider color
            function updateSliderColor() {
                const value = (tweetCountInput.value - tweetCountInput.min) / (tweetCountInput.max - tweetCountInput.min) * 100;
                tweetCountInput.style.setProperty('--slider-progress', `${value}%`);
            }
            updateSliderColor();

            tweetCountInput.addEventListener('input', (event) => {
                tweetCountDisplay.textContent = event.target.value;
                updateSliderColor();
            });

            textInput.addEventListener('input', () => {
                const words = textInput.value.trim().split(/\s+/).filter(word => word.length > 0).length;
                wordCountDisplay.textContent = `${words} / 5000 words`;
                blogContent = textInput.value;
            });

            imageToggle.addEventListener('change', (e) => {
                shouldGenerateImage = e.target.checked;
            });

            function setButtonLoadingState(isLoading, message = 'Converting...') {
                if (isLoading) {
                    convertBtn.textContent = message;
                    convertBtn.disabled = true;
                    convertBtn.classList.add('cursor-not-allowed', 'opacity-50');
                    loadingIndicator.classList.remove('hidden');
                } else {
                    convertBtn.textContent = 'Convert to Thread';
                    convertBtn.disabled = false;
                    convertBtn.classList.remove('cursor-not-allowed', 'opacity-50');
                    loadingIndicator.classList.add('hidden');
                }
            }

            convertBtn.addEventListener('click', async () => {
                const blogText = textInput.value.trim();
                const url = urlInput.value.trim();
                const tweetCount = parseInt(tweetCountInput.value, 10);
                const wordCount = blogText.split(/\s+/).filter(word => word.length > 0).length;

                if (url && blogText) {
                    showMessage("Please provide either a URL or text, not both.");
                    return;
                }
                
                if (!url && !blogText) {
                    showMessage("Please provide either a URL or text to convert.");
                    return;
                }

                if (wordCount > 5000) {
                    showMessage("Please ensure your blog content is 5000 words or less.");
                    return;
                }
                
                outputSection.classList.add('hidden');
                imageContainer.classList.add('hidden');
                generatedImage.src = '';
                downloadImageBtn.href = '';

                let contentToProcess = blogText;
                
                setButtonLoadingState(true, 'Finding blog content...');

                try {
                    if (url) {
                        const contentPayload = {
                            task: 'content',
                            url: url,
                        };
                        const contentResponse = await generateContent(contentPayload);
                        contentToProcess = contentResponse.text;
                    }

                    setButtonLoadingState(true, 'Generating your thread...');
                    const threadPayload = {
                        task: 'thread',
                        content: contentToProcess,
                        tweetCount: tweetCount,
                    };
                    const threadResponse = await generateContent(threadPayload);
                    
                    let tweets;
                    try {
                        const parsedResponse = JSON.parse(threadResponse.text);
                        tweets = parsedResponse.map(tweet => tweet.text);
                    } catch (e) {
                        console.error("Failed to parse JSON from thread response. Using raw text.");
                        showMessage("Warning: Thread formatting may be incorrect. Failed to parse JSON.");
                        tweets = threadResponse.text.split('\n').filter(t => t.trim().length > 0);
                    }
                    
                    if (tweets.length > tweetCount) {
                        tweets = tweets.slice(0, tweetCount);
                    }
                    
                    // Handle image generation
                    if (shouldGenerateImage) {
                        imageLoadingText.classList.remove('hidden');
                        try {
                            const imagePrompt = tweets[0].substring(0, 500); 
                            
                            const imagePayload = {
                                task: 'image',
                                imagePrompt: imagePrompt,
                            };
                            const imageResponse = await generateContent(imagePayload);
                            generatedImage.src = imageResponse.imageUrl;
                            downloadImageBtn.href = imageResponse.imageUrl;
                            imageContainer.classList.remove('hidden');
                        } catch (error) {
                            console.error("Error generating image:", error);
                            showMessage("Image generation failed: " + error.message);
                        } finally {
                            imageLoadingText.classList.add('hidden');
                        }
                    }

                    // Display tweets
                    tweetContainer.innerHTML = '';
                    tweets.forEach((tweet, index) => {
                        const tweetCard = document.createElement('div');
                        tweetCard.className = 'tweet-card p-4 rounded-xl bg-white shadow-md border border-gray-200 flex flex-col justify-between';
                        tweetCard.setAttribute('contenteditable', 'true');
                        tweetCard.innerHTML = `
                            <p class="text-gray-800">${index + 1}/${tweets.length} ${tweet}</p>
                            <button class="copy-tweet-btn mt-4 ml-auto py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-xs font-semibold transition duration-200">Copy Tweet</button>
                        `;
                        tweetContainer.appendChild(tweetCard);
                    });
                    
                    document.querySelectorAll('.copy-tweet-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const tweetText = e.target.closest('.tweet-card').querySelector('p').textContent.trim();
                            const textArea = document.createElement('textarea');
                            textArea.value = tweetText;
                            document.body.appendChild(textArea);
                            textArea.select();
                            try {
                                document.execCommand('copy');
                                showMessage("Successfully copied tweet to clipboard!", 2000);
                            } catch (err) {
                                console.error('Failed to copy single tweet:', err);
                                showMessage("Failed to copy tweet. Please copy the text manually.");
                            }
                            document.body.removeChild(textArea);
                        });
                    });
                } catch (error) {
                    console.error("Error generating thread:", error);
                    showMessage(error.message);
                } finally {
                    setButtonLoadingState(false);
                    outputSection.classList.remove('hidden');
                }
            });

            copyAllBtn.addEventListener('click', () => {
                const tweetElements = document.querySelectorAll('.tweet-card');
                let fullThreadText = '';
                tweetElements.forEach(tweet => {
                    fullThreadText += tweet.querySelector('p').textContent.trim() + '\n\n';
                });
                
                const textArea = document.createElement('textarea');
                textArea.value = fullThreadText.trim();
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showMessage("Successfully copied all tweets to clipboard!", 2000);
                } catch (err) {
                    console.error('Failed to copy text:', err);
                    showMessage("Failed to copy. Please copy the text manually.");
                }
                document.body.removeChild(textArea);
            });
        });
    </script>
</body>
</html>
